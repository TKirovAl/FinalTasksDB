# Info21 - Документация для защиты

## Структура проекта

Проект состоит из 4 основных файлов:
- `part1.sql` - Создание структуры БД
- `part2.sql` - Процедуры изменения данных и триггеры
- `part3.sql` - Функции получения данных
- `part4.sql` - Работа с метаданными
- `test_data.sql` - Тестовые данные

---

## Part 1: Создание базы данных

### Основные таблицы

1. **peers** - Студенты
   - Хранит никнеймы и даты рождения
   - PRIMARY KEY: nickname

2. **tasks** - Задания
   - Иерархическая структура с parenttask
   - Максимальное XP за задание
   - CHECK constraint: maxxp > 0

3. **checks** - Проверки
   - Связывает студента, задание и дату
   - FOREIGN KEY к peers и tasks

4. **p2p** - Peer-to-peer проверки
   - Статусы: Start, Success, Failure
   - Связь с проверяющим студентом

5. **verter** - Автоматические проверки
   - Запускается после успешной P2P
   - Статусы: Start, Success, Failure

6. **xp** - Полученный опыт
   - Привязан к успешным проверкам
   - Не может превышать maxxp

7. **transferredpoints** - Переданные баллы
   - Учет баллов между студентами

8. **friends** - Дружеские связи
   - CHECK: peer1 < peer2 (уникальность пары)

9. **recommendations** - Рекомендации
   - Студенты рекомендуют проверяющих

10. **timetracking** - Учет времени
    - state: 1 = вход, 2 = выход
    - Логирует посещения кампуса

### Индексы для оптимизации
- idx_checks_peer
- idx_checks_task
- idx_p2p_check
- idx_verter_check
- idx_xp_check
- idx_timetracking_peer_date

---

## Part 2: Процедуры и триггеры

### Процедура 1: add_p2p_check
**Назначение**: Добавление P2P проверки

**Параметры**:
- checked_peer - проверяемый студент
- checking_peer - проверяющий студент
- task_name - название задания
- check_state - статус (Start/Success/Failure)
- check_time - время

**Логика**:
1. Если статус Start → создает новую запись в checks
2. Если Success/Failure → находит соответствующую начатую проверку
3. Проверяет, что не существует финального статуса

**Пример вызова**:
```sql
CALL add_p2p_check('alex_s', 'maria_k', 'C1_SimpleBashUtils', 'Start', '10:00:00');
CALL add_p2p_check('alex_s', 'maria_k', 'C1_SimpleBashUtils', 'Success', '10:45:00');
```

### Процедура 2: add_verter_check
**Назначение**: Добавление Verter проверки

**Параметры**:
- checked_peer - студент
- task_name - задание
- verter_state - статус
- verter_time - время

**Логика**:
1. Ищет последнюю успешную P2P проверку
2. Проверяет отсутствие Verter для этой проверки
3. Добавляет запись Verter

**Особенность**: Verter запускается ТОЛЬКО после успешной P2P

### Триггер 1: p2p_audit_trigger
**Назначение**: Аудит изменений в P2P

**Функция**: audit_p2p_changes()
- Логирует INSERT/UPDATE/DELETE
- Сохраняет в таблицу p2p_audit
- Использует JSONB для хранения данных

**Срабатывание**: AFTER INSERT OR UPDATE OR DELETE

### Триггер 2: xp_validation_trigger
**Назначение**: Валидация XP

**Функция**: validate_xp()
**Проверки**:
1. XP не превышает maxxp для задания
2. P2P проверка успешна (Success)
3. Если есть Verter, он тоже Success

**Срабатывание**: BEFORE INSERT
**Важно**: Предотвращает некорректное начисление XP

### Триггер 3: transferred_points_trigger
**Назначение**: Автоматическое начисление баллов

**Функция**: update_transferred_points()
**Логика**:
1. Срабатывает на P2P со статусом Start
2. Начисляет 1 балл от проверяемого проверяющему
3. Если запись существует - увеличивает, иначе создает

**Срабатывание**: AFTER INSERT на p2p

---

## Part 3: Функции получения данных

### Функция 1: get_transferred_points_readable()
**Возвращает**: Peer1, Peer2, PointsAmount
**Логика**: 
- Вычисляет разницу баллов между парами студентов
- PointsAmount = (от Peer1 к Peer2) - (от Peer2 к Peer1)

### Функция 2: get_successful_checks_with_xp()
**Возвращает**: Peer, Task, XP
**Условия**: P2P Success И (Verter Success или отсутствует)

### Функция 3: get_peers_not_left_campus(check_date)
**Параметр**: Дата
**Возвращает**: Студентов, которые не покидали кампус весь день
**Логика**: Первая запись = вход, последняя ≠ выход

### Функция 4: get_peer_points_change()
**Возвращает**: Peer, PointsChange
**Логика**: 
- Полученные баллы - отданные баллы
- Положительное значение = студент в плюсе

### Функция 5: get_peer_points_change_v2()
**Аналог функции 4**, но использует get_transferred_points_readable()

### Функция 6: get_most_checked_task_per_day()
**Возвращает**: Day, Task
**Логика**: Для каждого дня находит задание с max проверками
**Использует**: ROW_NUMBER() OVER (PARTITION BY date)

### Функция 7: get_peers_completed_block(block_name)
**Параметр**: Название блока (например, 'C', 'DO')
**Возвращает**: Студентов, завершивших ВСЕ задания блока
**Логика**: Последняя проверка каждого задания = Success

### Функция 8: get_recommended_peer_for_check()
**Возвращает**: Peer, RecommendedPeer
**Логика**: 
- Анализирует рекомендации от друзей
- Выбирает наиболее рекомендуемого

### Функция 9: get_blocks_statistics(block1, block2)
**Параметры**: Два блока заданий
**Возвращает**: Проценты студентов, начавших:
- Только block1
- Только block2
- Оба блока
- Ни один блок

### Функция 10: get_birthday_checks_statistics()
**Возвращает**: SuccessfulChecks%, UnsuccessfulChecks%
**Логика**: Анализирует проверки в дни рождения студентов

### Функция 11: get_total_xp_by_peer()
**Возвращает**: Peer, суммарное XP
**Сортировка**: По убыванию XP

### Функция 12: get_peers_with_specific_tasks(task1, task2, task3)
**Логика**: Студенты с task1 И task2, но БЕЗ task3
**Использование**: Анализ прогресса студентов

### Функция 13: get_task_hierarchy_count()
**Возвращает**: Task, количество предыдущих заданий
**Использует**: Рекурсивный CTE для обхода дерева

### Функция 14: get_top_xp_days(n)
**Параметр**: Количество дней
**Возвращает**: N дней с максимальной суммой XP

### Функция 15: get_early_entry_peers(entry_time, n)
**Параметры**: Время и минимальное количество раз
**Возвращает**: Студентов, зашедших раньше времени ≥ n раз

### Функция 16: get_frequent_exit_peers(n, m)
**Параметры**: n выходов за m дней
**Возвращает**: Студентов, часто покидавших кампус

### Функция 17: get_early_entries_percentage()
**Возвращает**: Month, процент ранних входов (до 12:00)
**Логика**: Анализирует первые входы в месяцы рождения

---

## Part 4: Работа с метаданными

### Процедура 1: drop_tables_by_prefix()
**Назначение**: Удаление таблиц с префиксом 'table'
**Использует**: Динамический SQL, pg_tables
**Особенность**: CASCADE удаляет зависимости

### Процедура 2: list_scalar_functions()
**Назначение**: Вывод списка скалярных функций
**Выводит**: Имя, возвращаемый тип, параметры
**Фильтрация**: Только функции (не процедуры), не таблицы

### Процедура 3: drop_all_dml_triggers()
**Назначение**: Удаление всех DML триггеров
**DML**: INSERT, UPDATE, DELETE триггеры
**Сохраняет**: Системные и DDL триггеры

### Процедура 4: search_objects_by_string(search_string)
**Параметр**: Строка поиска
**Ищет в**: Функциях, процедурах, таблицах, представлениях, триггерах
**Использует**: ILIKE для поиска без учета регистра

### Дополнительная процедура: create_test_tables()
**Назначение**: Создание тестовых таблиц
**Использование**: Для тестирования drop_tables_by_prefix()

### Дополнительная процедура: get_database_statistics()
**Назначение**: Вывод статистики БД
**Считает**: Таблицы, функции, процедуры, триггеры, представления

---

## Тестирование

### Последовательность выполнения:
```bash
# 1. Создание структуры
psql -f part1.sql

# 2. Добавление процедур и триггеров
psql -f part2.sql

# 3. Добавление функций
psql -f part3.sql

# 4. Работа с метаданными
psql -f part4.sql

# 5. Загрузка тестовых данных
psql -f test_data.sql
```

### Примеры тестовых запросов:
```sql
-- Проверка transferred points
SELECT * FROM get_transferred_points_readable();

-- Студенты с XP
SELECT * FROM get_successful_checks_with_xp();

-- Статистика по блокам
SELECT * FROM get_blocks_statistics('C', 'DO');

-- Процедура добавления P2P
CALL add_p2p_check('test_peer', 'checker', 'C1_SimpleBashUtils', 'Start', '10:00:00');

-- Список функций
CALL list_scalar_functions();

-- Статистика БД
CALL get_database_statistics();
```
